<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --edit: #e67e22; --rent: #8e44ad; }
        body { background: #f4f6f7; transition: background 0.3s; }
        
        /* Modos visuales */
        .mode-normal .navbar { background: var(--primary); }
        .mode-edit .navbar { background: var(--edit); }
        .mode-edit body { background: #fdf2e9; }
        .mode-rent .navbar { background: var(--rent); }
        
        .card-prod { background: white; border-radius: 12px; margin-bottom: 10px; padding: 15px; border-left: 5px solid transparent; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-prod.type-venta { border-left-color: #2ecc71; }
        .card-prod.type-alquiler { border-left-color: #8e44ad; }
        
        .detalle-box { display: none; background: #fff; padding: 15px; margin-top: -5px; border-radius: 0 0 12px 12px; border: 1px solid #ddd; border-top:none; margin-bottom: 10px; }
        .img-prod { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body class="mode-normal">

<nav class="navbar navbar-dark sticky-top px-3 shadow-sm">
    <div class="d-flex align-items-center gap-2">
        <select id="modeSelector" class="form-select form-select-sm" style="width: 130px;" onchange="cambiarModo()">
            <option value="normal">üîµ Normal</option>
            <option value="alquiler">üü£ Alquiler</option>
            <option value="edicion">üü† Edici√≥n</option>
        </select>
        <span class="text-white fw-bold ms-2 d-none d-sm-block">INVENTARIO</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-light" onclick="abrirReportes()">üìÑ Reportes</button>
        <button class="btn btn-sm btn-light fw-bold" onclick="modalNuevo()">‚ûï Nuevo</button>
    </div>
</nav>

<div class="container mt-3">
    <input type="text" id="buscador" class="form-control shadow-sm mb-3" placeholder="üîç Buscar producto..." onkeyup="renderizar()">
    <div id="contenedorLista" class="pb-5"><div class="text-center mt-5"><div class="spinner-border"></div></div></div>
</div>

<div class="modal fade" id="modalForm" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 id="modalTitle">Producto</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="prodId">
                <div class="mb-2"><label>Nombre:</label><input type="text" id="pNombre" class="form-control"></div>
                <div class="mb-2"><label>Precio:</label><input type="number" id="pPrecio" class="form-control"></div>
                <div class="mb-2"><label>Tipo:</label>
                    <select id="pTipo" class="form-select">
                        <option value="Venta">Venta</option>
                        <option value="Alquiler">Alquiler</option>
                    </select>
                </div>
                <div class="mb-2"><label>Stock Inicial:</label><input type="number" id="pStock" class="form-control"></div>
                <div class="mb-3"><label>Imagen URL:</label><input type="text" id="pImg" class="form-control"></div>
                
                <div id="divOrden" class="d-none border-top pt-2">
                    <label>Reordenar (N√∫mero de posici√≥n):</label>
                    <input type="number" id="pOrden" class="form-control">
                </div>

                <button class="btn btn-primary w-100 mt-3" onclick="guardarProducto()">GUARDAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalReporte" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Gesti√≥n de Reportes</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="searchCode" class="form-control" placeholder="Ingresa c√≥digo de remisi√≥n...">
                    <button class="btn btn-outline-secondary" onclick="buscarReporte()">Buscar</button>
                </div>
                
                <div id="areaImpresion" class="border p-3 bg-white">
                    <div class="d-flex justify-content-between">
                        <h4>REPORTE DE PRODUCTOS</h4>
                        <div class="text-end">
                            <small id="repFecha">Fecha: --/--/----</small><br>
                            <h5 class="text-danger" id="repCodigo">Borrador</h5>
                        </div>
                    </div>
                    <hr>
                    <table class="table table-sm text-center" style="font-size:0.9rem">
                        <thead><tr class="table-secondary"><th>Producto</th><th>Bodega</th><th>Vend</th><th>Surt</th><th>Alq</th></tr></thead>
                        <tbody id="tablaReporte"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger me-auto" onclick="borrarReporte()" id="btnBorrarRep" style="display:none">Eliminar este reporte</button>
                <button class="btn btn-warning" onclick="limpiarReporte()">Limpiar</button>
                <button class="btn btn-success" onclick="guardarReporte()">üíæ Guardar y Generar C√≥digo</button>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN (Rellena esto)
    const URL_API = "https://script.google.com/macros/s/AKfycbxE-MrUxn4CzH6wkjwe75kUcgRsHc8rCi31mCf6hysDpxjlml8xa8Vw-oQ_STytBXPp/exec"; 
    const API_KEY = "123456"; // Debe coincidir con Apps Script

    // ESTADO
    let productos = [];
    let itemsReporte = []; // Lista temporal para el reporte
    let modoActual = "normal"; // normal, alquiler, edicion

    // INICIO
    window.onload = cargarDatos;

    async function api(payload) {
        payload.key = API_KEY;
        try {
            const res = await fetch(URL_API, { method: 'POST', body: JSON.stringify(payload) });
            return (await res.json()).resultado;
        } catch(e) { alert("Error de conexi√≥n"); return null; }
    }

    async function cargarDatos() {
        productos = await api({ accion: "obtener" });
        renderizar();
    }

    function cambiarModo() {
        modoActual = document.getElementById('modeSelector').value;
        document.body.className = `mode-${modoActual}`; // Cambia CSS
        renderizar();
    }

    function renderizar() {
        const txt = document.getElementById('buscador').value.toLowerCase();
        let html = '';
        
        // Filtros seg√∫n modo
        let lista = productos.filter(p => {
            if (!p.nombre.toLowerCase().includes(txt)) return false;
            if (modoActual === 'normal') return p.tipo === 'Venta';
            if (modoActual === 'alquiler') return p.tipo === 'Alquiler';
            return true; // Edici√≥n muestra todo
        });

        if (lista.length === 0) html = '<div class="text-center text-muted mt-4">No hay productos en esta vista</div>';

        lista.forEach(p => {
            html += `
            <div class="card-prod type-${p.tipo.toLowerCase()}" onclick="toggleDetalle('${p.id}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-3 align-items-center">
                        ${modoActual === 'edicion' ? `<span class="badge bg-secondary">#${p.orden}</span>` : ''}
                        <div>
                            <div class="fw-bold">${p.nombre}</div>
                            <div class="small text-muted">$${p.precio} | Stock: ${p.stock}</div>
                        </div>
                    </div>
                    ${modoActual === 'alquiler' ? `<span class="badge bg-warning text-dark">Alq: ${p.alquilados}</span>` : ''}
                    ${modoActual === 'normal' ? `<span class="badge bg-success">Total: ${p.stock}</span>` : ''}
                </div>
            </div>
            
            <div id="det-${p.id}" class="detalle-box shadow-sm" onclick="event.stopPropagation()">
                ${generarHTMLDetalle(p)}
            </div>`;
        });
        document.getElementById('contenedorLista').innerHTML = html;
    }

    function generarHTMLDetalle(p) {
        // VISTA EDICI√ìN
        if (modoActual === 'edicion') {
            return `
                <div class="text-center mb-2"><img src="${p.imagen}" class="img-prod"></div>
                <button class="btn btn-warning w-100" onclick="modalEditar('${p.id}')">‚úèÔ∏è EDITAR DETALLES</button>
            `;
        }
        
        // VISTA NORMAL O ALQUILER
        let botones = '';
        if (modoActual === 'normal') {
            botones = `
                <div class="col-6"><input type="number" id="in-s-${p.id}" class="form-control" placeholder="Surtir (+)"><button class="btn btn-sm btn-success w-100 mt-1" onclick="movimiento('${p.id}','surtir')">Guardar</button></div>
                <div class="col-6"><input type="number" id="in-v-${p.id}" class="form-control" placeholder="Vendido (-)"><button class="btn btn-sm btn-danger w-100 mt-1" onclick="movimiento('${p.id}','vender')">Guardar</button></div>
            `;
        } else {
            botones = `
                <div class="col-6"><input type="number" id="in-s-${p.id}" class="form-control" placeholder="Surtir (Bodega)"><button class="btn btn-sm btn-success w-100 mt-1" onclick="movimiento('${p.id}','surtir')">Surtir</button></div>
                <div class="col-6"><input type="number" id="in-a-${p.id}" class="form-control" placeholder="Alquilar (Salida)"><button class="btn btn-sm btn-warning w-100 mt-1" onclick="movimiento('${p.id}','alquilar')">Alquilar</button></div>
                <div class="col-12 mt-2"><button class="btn btn-outline-primary w-100" onclick="devolucion('${p.id}')">üîÑ Devoluci√≥n (Regreso a bodega)</button></div>
            `;
        }

        return `
            <div class="d-flex gap-3 mb-2">
                <img src="${p.imagen}" class="img-prod" onerror="this.src='https://via.placeholder.com/80'">
                <div class="row w-100 g-1">${botones}</div>
            </div>
            <button class="btn btn-outline-dark btn-sm w-100" onclick="agregarAlReporte('${p.id}')">üìå Agregar a Reporte</button>
        `;
    }

    // --- L√ìGICA DE MOVIMIENTOS ---
    async function movimiento(id, tipo) {
        let valId = tipo === 'alquilar' ? `in-a-${id}` : (tipo === 'vender' ? `in-v-${id}` : `in-s-${id}`);
        let val = Number(document.getElementById(valId).value);
        if(val <= 0) return alert("Ingresa cantidad v√°lida");
        
        if(confirm(`¬øConfirmar ${tipo}: ${val}?`)) {
            await api({ accion: "movimiento", id: id, tipoMov: tipo, valor: val });
            cargarDatos();
        }
    }

    function devolucion(id) {
        let cant = prompt("¬øCu√°ntos productos regresan del alquiler?");
        if(cant > 0) {
            api({ accion: "movimiento", id: id, tipoMov: "devolver", valor: Number(cant) }).then(cargarDatos);
        }
    }

    // --- L√ìGICA AGREGAR/EDITAR ---
    let modalEl;
    function modalNuevo() {
        document.getElementById('modalForm').querySelectorAll('input').forEach(i => i.value='');
        document.getElementById('prodId').value = ''; 
        document.getElementById('modalTitle').innerText = "Nuevo Producto";
        document.getElementById('divOrden').classList.add('d-none');
        modalEl = new bootstrap.Modal(document.getElementById('modalForm'));
        modalEl.show();
    }

    function modalEditar(id) {
        let p = productos.find(x => x.id == id);
        document.getElementById('prodId').value = p.id;
        document.getElementById('pNombre').value = p.nombre;
        document.getElementById('pPrecio').value = p.precio;
        document.getElementById('pTipo').value = p.tipo;
        document.getElementById('pStock').value = p.stock;
        document.getElementById('pImg').value = p.imagen;
        document.getElementById('pOrden').value = p.orden;
        
        document.getElementById('divOrden').classList.remove('d-none');
        document.getElementById('modalTitle').innerText = "Editar Producto";
        modalEl = new bootstrap.Modal(document.getElementById('modalForm'));
        modalEl.show();
    }

    async function guardarProducto() {
        const id = document.getElementById('prodId').value;
        const datos = {
            nombre: document.getElementById('pNombre').value,
            precio: document.getElementById('pPrecio').value,
            tipo: document.getElementById('pTipo').value,
            stock: document.getElementById('pStock').value,
            imagen: document.getElementById('pImg').value
        };

        if (id) { // Editar
            datos.id = id;
            datos.accion = "editar";
            datos.nuevoOrden = document.getElementById('pOrden').value;
        } else { // Nuevo
            datos.accion = "agregar";
        }

        await api(datos);
        modalEl.hide();
        cargarDatos();
    }

    // --- L√ìGICA DE REPORTES ---
    function agregarAlReporte(id) {
        let p = productos.find(x => x.id == id);
        // Evitar duplicados en visualizaci√≥n
        if(!itemsReporte.find(x => x.id == id)) {
            itemsReporte.push(p);
            alert("Agregado al reporte temporal");
            dibujarTablaReporte();
        } else {
            alert("Ya est√° en el reporte");
        }
    }

    function abrirReportes() {
        dibujarTablaReporte();
        new bootstrap.Modal(document.getElementById('modalReporte')).show();
    }

    function dibujarTablaReporte() {
        let html = '';
        itemsReporte.forEach(p => {
            html += `<tr>
                <td>${p.nombre}</td>
                <td>${p.stock}</td>
                <td>${p.vendidos}</td>
                <td>${p.surtidos}</td>
                <td>${p.tipo === 'Alquiler' ? p.alquilados : '-'}</td>
            </tr>`;
        });
        document.getElementById('tablaReporte').innerHTML = html;
        document.getElementById('repFecha').innerText = "Fecha: " + new Date().toLocaleDateString();
    }

    async function guardarReporte() {
        if(itemsReporte.length === 0) return alert("Reporte vac√≠o");
        const codigo = "REM-" + Math.floor(Math.random() * 10000);
        await api({ accion: "guardar_reporte", codigo: codigo, items: itemsReporte });
        document.getElementById('repCodigo').innerText = codigo;
        alert("Guardado con c√≥digo: " + codigo);
    }

    async function buscarReporte() {
        const cod = document.getElementById('searchCode').value;
        const res = await api({ accion: "buscar_reporte", codigo: cod });
        if(res.encontrado) {
            itemsReporte = res.items;
            document.getElementById('repCodigo').innerText = cod;
            document.getElementById('btnBorrarRep').style.display = 'block';
            dibujarTablaReporte();
        } else {
            alert("C√≥digo no encontrado");
        }
    }

    async function borrarReporte() {
        const cod = document.getElementById('repCodigo').innerText;
        if(confirm("Eliminar reporte " + cod)) {
            await api({ accion: "borrar_reporte", codigo: cod });
            limpiarReporte();
        }
    }

    function limpiarReporte() {
        itemsReporte = [];
        document.getElementById('repCodigo').innerText = "Borrador";
        document.getElementById('searchCode').value = "";
        document.getElementById('btnBorrarRep').style.display = 'none';
        dibujarTablaReporte();
    }

    function toggleDetalle(id) {
        const el = document.getElementById(`det-${id}`);
        const actual = el.style.display;
        document.querySelectorAll('.detalle-box').forEach(d => d.style.display='none');
        el.style.display = actual === 'block' ? 'none' : 'block';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
