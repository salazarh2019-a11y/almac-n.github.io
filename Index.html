<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    
    /* Header */
    .header-app { background: #2c3e50; color: white; padding: 15px; text-align: center; transition: background 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    .header-edit-mode { background: #c0392b !important; } 
    
    /* Cards */
    .producto-card { border: none; padding: 15px; cursor: pointer; background: white; margin-bottom: 8px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .producto-card:active { transform: scale(0.98); }
    
    /* Detalles */
    .detalle-producto { display: none; padding: 15px; background: #eef2f7; border-radius: 0 0 10px 10px; margin-top: -5px; margin-bottom: 8px; border: 1px solid #dee2e6; border-top: none; }
    
    /* Imagen y Precio */
    .img-prod { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .price-tag { color: #27ae60; font-weight: 700; font-size: 0.95rem; }
    .stock-badge { min-width: 80px; text-align: center; }
    
    /* Buscador */
    .search-container { background: white; padding: 10px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
  </style>
</head>
<body>

<div id="mainHeader" class="header-app">
  <div class="d-flex justify-content-between align-items-center px-1">
    <button class="btn btn-outline-light btn-sm" onclick="mostrarFactura()">üßæ LISTA</button>
    
    <div style="cursor:pointer; user-select: none;" onclick="detectarTripleClic(event)">
      <h5 class="m-0 fw-bold">ALMACENAMIENTO</h5>
      <small id="statusConexion" style="font-size: 0.7rem; opacity: 0.8;">üü¢ En l√≠nea</small>
    </div>

    <button class="btn btn-outline-light btn-sm" onclick="modalAgregar()">‚ûï AGREGAR</button>
  </div>
  <small id="avisoModo" style="display:none; color: #ffeaa7; font-weight:bold; margin-top:5px;">‚ö†Ô∏è MODO EDICI√ìN ACTIVO</small>
</div>

<div class="container px-0">
  <div class="search-container container">
    <div class="input-group">
      <span class="input-group-text border-0 bg-light">üîç</span>
      <input type="text" id="buscador" class="form-control border-0 bg-light" placeholder="Buscar producto..." onkeyup="filtrar()">
    </div>
  </div>

  <div class="container pb-5" id="contenedorLista">
    <div id="listaProductos">
      <div class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Cargando inventario...</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalFactura" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Reporte de Movimientos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contenidoFactura"></div>
      <div class="modal-footer bg-light">
        <button class="btn btn-outline-danger" onclick="reiniciar()">üóëÔ∏è Reiniciar Todo</button>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Descargar / Imprimir</button>
      </div>
    </div>
  </div>
</div>

<script>
  // VARIABLES GLOBALES
  let productosGlobal = [];
  let modoEdicion = false;
  let clickCount = 0;
  
  // Variable para recordar qu√© tarjeta estaba abierta al recargar
  let indiceAbierto = -1; 

  // --- 1. INICIALIZACI√ìN Y BUCLE DE ACTUALIZACI√ìN ---
  window.onload = function() {
    cargar();
    // Bucle: revisa datos cada 5 segundos
    setInterval(autoActualizar, 5000);
  };

  function cargar() {
    google.script.run.withSuccessHandler(procesarDatos).obtenerProductos();
  }

  function autoActualizar() {
    // REGLA: No actualizar si el usuario est√° escribiendo o editando para no molestar
    if (document.querySelector('input:focus')) return; 
    if (modoEdicion) return;

    google.script.run.withSuccessHandler(nuevosDatos => {
      // Convertimos a texto para comparar si algo cambi√≥
      if (JSON.stringify(nuevosDatos) !== JSON.stringify(productosGlobal)) {
        console.log("Cambios detectados en la base de datos. Actualizando...");
        procesarDatos(nuevosDatos);
        
        // Efecto visual discreto en el indicador de estado
        let status = document.getElementById('statusConexion');
        status.innerHTML = "üîÑ Actualizando...";
        setTimeout(() => status.innerHTML = "üü¢ En l√≠nea", 1500);
      }
    }).obtenerProductos();
  }

  function procesarDatos(datos) {
    productosGlobal = datos;
    filtrar(); // Esto llama a renderizar internamente
  }

  // --- 2. RENDERIZADO (DIBUJAR EN PANTALLA) ---
  function renderizar(datos) {
    let html = '';
    
    if(datos.length === 0) {
      document.getElementById('listaProductos').innerHTML = '<p class="text-center text-muted mt-4">No se encontraron productos.</p>';
      return;
    }

    // Mapeamos los datos originales para mantener el √≠ndice real de la base de datos
    // datos puede ser una lista filtrada, por eso necesitamos saber el √≠ndice real en productosGlobal
    datos.forEach((p) => {
      // Buscamos el √≠ndice real en el array global para que los botones funcionen bien
      let i = productosGlobal.findIndex(item => item[0] === p[0]);
      
      html += `
        <div class="producto-card" onclick="gestionarClicProducto(${i})">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
               <div style="width:40px; height:40px; background: #eee; border-radius:50%; overflow:hidden; flex-shrink:0;">
                  <img src="${p[3]}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'">
               </div>
               <div>
                  <div class="fw-bold text-dark">${p[0]}</div>
                  <div class="price-tag">$${p[2]}</div>
               </div>
            </div>
            <span class="badge ${p[1] > 0 ? 'bg-primary' : 'bg-danger'} rounded-pill stock-badge p-2">
              ${p[1]} Unds
            </span>
          </div>
        </div>
        
        <div id="detalle-${i}" class="detalle-producto" onclick="event.stopPropagation()">
           </div>
      `;
    });
    
    document.getElementById('listaProductos').innerHTML = html;

    // Si hab√≠a una tarjeta abierta, intentamos reabrirla visualmente
    if(indiceAbierto !== -1) {
      let el = document.getElementById(`detalle-${indiceAbierto}`);
      if(el) {
        el.style.display = 'block';
        llenarDetalle(indiceAbierto); // Rellenar contenido
      } else {
        indiceAbierto = -1; // Si el producto desapareci√≥ (filtro), reseteamos
      }
    }
  }

  // --- 3. L√ìGICA DE INTERACCI√ìN ---
  function gestionarClicProducto(i) {
    const contenedor = document.getElementById(`detalle-${i}`);
    
    // Si ya est√° abierto, lo cerramos
    if (contenedor.style.display === 'block') {
      contenedor.style.display = 'none';
      indiceAbierto = -1;
      return;
    }

    // Cerrar todos los dem√°s primero (Acorde√≥n)
    document.querySelectorAll('.detalle-producto').forEach(el => el.style.display = 'none');

    // Abrir el actual
    contenedor.style.display = 'block';
    indiceAbierto = i;
    llenarDetalle(i);
  }

  function llenarDetalle(i) {
    const contenedor = document.getElementById(`detalle-${i}`);
    const producto = productosGlobal[i];

    if (modoEdicion) {
      // VISTA DE EDICI√ìN
      contenedor.innerHTML = `
        <div class="bg-white p-3 rounded border">
            <h6 class="text-danger fw-bold border-bottom pb-2 mb-3">üîß EDITAR DATOS</h6>
            <div class="mb-2">
                <label class="small text-muted">Nombre:</label>
                <input type="text" id="edit-nombre-${i}" class="form-control" value="${producto[0]}">
            </div>
            <div class="mb-2">
                <label class="small text-muted">Precio:</label>
                <input type="number" id="edit-precio-${i}" class="form-control" value="${producto[2]}">
            </div>
            <div class="mb-2">
                <label class="small text-muted">URL Foto:</label>
                <input type="text" id="edit-url-${i}" class="form-control" value="${producto[3]}">
            </div>
            <button class="btn btn-danger w-100 mt-2" onclick="guardarEdicion(${i})">GUARDAR CAMBIOS</button>
        </div>
      `;
    } else {
      // VISTA NORMAL (OPERATIVA)
      contenedor.innerHTML = `
        <div class="d-flex flex-column flex-sm-row gap-3">
            <img src="${producto[3]}" class="img-prod mx-auto mx-sm-0" onerror="this.src='https://via.placeholder.com/150?text=Sin+Foto'">
            <div class="w-100">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small fw-bold text-success">SURTIR (+)</label>
                        <input type="number" id="surtir-${i}" class="form-control border-success" placeholder="Cantidad">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-danger">VENDER (-)</label>
                        <input type="number" id="vendido-${i}" class="form-control border-danger" placeholder="Cantidad">
                    </div>
                    <div class="col-12 mt-3">
                        <button class="btn btn-dark w-100 py-2" onclick="guardarMovimiento(${i})">
                          üíæ GUARDAR MOVIMIENTO
                        </button>
                    </div>
                </div>
            </div>
        </div>
      `;
    }
  }

  // --- 4. FUNCIONES DE GUARDADO ---
  function guardarMovimiento(i) {
    let sInput = document.getElementById(`surtir-${i}`);
    let vInput = document.getElementById(`vendido-${i}`);
    let s = Number(sInput.value);
    let v = Number(vInput.value);
    let nombre = productosGlobal[i][0];
    
    // Bloquear botones visualmente
    sInput.disabled = true; vInput.disabled = true;

    if(s > 0) google.script.run.withSuccessHandler(res => postGuardado(res)).actualizarStock(nombre, s, 'surtir');
    else if(v > 0) google.script.run.withSuccessHandler(res => postGuardado(res)).actualizarStock(nombre, v, 'vendido');
    else { alert("Escribe un n√∫mero para guardar."); sInput.disabled = false; vInput.disabled = false; }
  }

  function postGuardado(res) {
    alert("‚úÖ " + res);
    indiceAbierto = -1; // Cerrar tarjeta tras guardar
    cargar(); // Recargar datos inmediatamente
  }

  function guardarEdicion(i) {
    let nombreOriginal = productosGlobal[i][0];
    let nuevoNombre = document.getElementById(`edit-nombre-${i}`).value;
    let nuevoPrecio = document.getElementById(`edit-precio-${i}`).value;
    let nuevaUrl = document.getElementById(`edit-url-${i}`).value;

    if(confirm("¬øGuardar los cambios del producto?")) {
        google.script.run.withSuccessHandler(res => {
            alert(res);
            toggleModoEdicion(); // Salir del modo edici√≥n
            cargar();
        }).editarProducto(nombreOriginal, nuevoNombre, nuevoPrecio, nuevaUrl);
    }
  }

  // --- 5. OTRAS UTILIDADES ---
  function filtrar() {
    let txt = document.getElementById('buscador').value.toLowerCase();
    // Filtramos sobre el array global
    let filtrados = productosGlobal.filter(p => String(p[0]).toLowerCase().includes(txt));
    renderizar(filtrados);
  }

  function detectarTripleClic(e) {
    if (e.detail === 3) toggleModoEdicion();
  }

  function toggleModoEdicion() {
    modoEdicion = !modoEdicion;
    const header = document.getElementById('mainHeader');
    const aviso = document.getElementById('avisoModo');
    
    if (modoEdicion) {
      header.classList.add('header-edit-mode');
      aviso.style.display = 'block';
    } else {
      header.classList.remove('header-edit-mode');
      aviso.style.display = 'none';
    }
    indiceAbierto = -1; // Resetear acorde√≥n
    filtrar(); // Re-renderizar para aplicar cambios de vista
  }

  function modalAgregar() {
    let n = prompt("NOMBRE del nuevo producto:");
    if(!n) return;
    let p = prompt("PRECIO por unidad:");
    if(!p) return;
    let u = prompt("URL de la FOTO (Opcional):", "https://");
    
    google.script.run.withSuccessHandler(res => {
        alert(res);
        cargar();
    }).agregarProducto(n, p, u);
  }

  function mostrarFactura() {
    let html = '<div class="table-responsive"><table class="table table-striped table-sm align-middle"><thead><tr class="table-dark"><th>Producto</th><th>Cant.</th><th>Vend.</th><th>Surt.</th></tr></thead><tbody>';
    
    let hayDatos = false;
    productosGlobal.forEach(p => {
      if(p[4]>0 || p[5]>0){ // Col E (4) es Vendido, Col F (5) es Surtido
        hayDatos = true;
        html += `<tr>
            <td><strong>${p[0]}</strong><br><small class="text-muted">$${p[2]}</small></td>
            <td><span class="badge bg-secondary">${p[1]}</span></td>
            <td class="text-danger fw-bold">-${p[4]}</td>
            <td class="text-success fw-bold">+${p[5]}</td>
        </tr>`;
      }
    });
    
    if(!hayDatos) html += '<tr><td colspan="4" class="text-center py-3">No hay movimientos hoy.</td></tr>';
    
    html += '</tbody></table></div>';
    html += `<div class="alert alert-light border mt-2 text-center small">üìÖ Fecha de reporte: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>`;
    
    document.getElementById('contenidoFactura').innerHTML = html;
    new bootstrap.Modal(document.getElementById('modalFactura')).show();
  }

  function reiniciar() {
    if(confirm("‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\n¬øEst√°s seguro de reiniciar la factura a CERO?\nSe borrar√° el historial de lo vendido y surtido hoy.")) {
      google.script.run.withSuccessHandler(() => {
          cargar();
          bootstrap.Modal.getInstance(document.getElementById('modalFactura')).hide();
      }).reiniciarFactura();
    }
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
