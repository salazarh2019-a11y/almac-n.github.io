<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario GitHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; }
        .header-app { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        .producto-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; border-left: 5px solid #3498db; }
        .detalle-box { display: none; background: #fdfdfd; padding: 15px; border: 1px solid #ddd; border-radius: 0 0 10px 10px; margin-top: -10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header-app">
    <h5>GESTIÃ“N DE ALMACÃ‰N</h5>
    <div class="d-flex justify-content-around mt-2">
        <button class="btn btn-outline-light btn-sm" onclick="mostrarFactura()">REPORTE</button>
        <button class="btn btn-outline-light btn-sm" onclick="abrirModal()">âž• NUEVO</button>
    </div>
</div>

<div class="container mt-3">
    <input type="text" id="buscador" class="form-control mb-3" placeholder="ðŸ” Buscar..." onkeyup="filtrar()">
    <div id="listaProductos"><p class="text-center">Conectando con la API...</p></div>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>Nuevo Producto</h5></div>
            <div class="modal-body">
                <input type="text" id="nN" class="form-control mb-2" placeholder="Nombre">
                <input type="number" id="nP" class="form-control mb-2" placeholder="Precio">
                <input type="text" id="nU" class="form-control mb-2" placeholder="URL Imagen">
                <button class="btn btn-primary w-100" onclick="enviarNuevo()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // PEGA AQUÃ TU URL DE GOOGLE APPS SCRIPT
    const URL_API = "https://script.google.com/macros/s/AKfycbzEIHb-NstGJnt3ff-K7YZnjBFL186EgCx5O8q7VpdnMu9FlQGqVNuF8sdu7hdovu2S/exec";
    
    let productos = [];

    async function cargar() {
        try {
            const resp = await fetch(URL_API);
            productos = await resp.json();
            renderizar(productos);
        } catch (e) {
            document.getElementById('listaProductos').innerHTML = "Error de conexiÃ³n.";
        }
    }

    function renderizar(datos) {
        let html = '';
        datos.forEach((p, i) => {
            html += `
                <div class="producto-card" onclick="toggle(${i})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><b>${p[0]}</b><br><small class="text-success">$${p[2]}</small></div>
                        <span class="badge bg-primary">${p[1]}</span>
                    </div>
                </div>
                <div id="det-${i}" class="detalle-box">
                    <div class="row g-2">
                        <div class="col-6"><input type="number" id="s-${i}" class="form-control" placeholder="Surtir"></div>
                        <div class="col-6"><input type="number" id="v-${i}" class="form-control" placeholder="Vendido"></div>
                        <button class="btn btn-dark btn-sm mt-2" onclick="guardarMov(${i})">Guardar</button>
                    </div>
                </div>`;
        });
        document.getElementById('listaProductos').innerHTML = html;
    }

    async function guardarMov(i) {
        const s = Number(document.getElementById(`s-${i}`).value);
        const v = Number(document.getElementById(`v-${i}`).value);
        const data = {
            accion: "movimiento",
            nombre: productos[i][0],
            tipo: s > 0 ? 'surtir' : 'vendido',
            valor: s > 0 ? s : v
        };
        await fetch(URL_API, { method: 'POST', body: JSON.stringify(data) });
        alert("Actualizado");
        cargar();
    }

    async function enviarNuevo() {
        const data = {
            accion: "agregar",
            nombre: document.getElementById('nN').value,
            precio: document.getElementById('nP').value,
            url: document.getElementById('nU').value
        };
        await fetch(URL_API, { method: 'POST', body: JSON.stringify(data) });
        location.reload();
    }

    function toggle(i) {
        const el = document.getElementById(`det-${i}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function abrirModal() { new bootstrap.Modal(document.getElementById('modalAdd')).show(); }
    
    function filtrar() {
        const t = document.getElementById('buscador').value.toLowerCase();
        renderizar(productos.filter(p => p[0].toLowerCase().includes(t)));
    }

    window.onload = cargar;
    setInterval(cargar, 10000); // Actualiza cada 10 seg
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
